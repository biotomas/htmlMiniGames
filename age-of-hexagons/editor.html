<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <title>Age of Hexagons, Level Editor</title>
    <style type="text/css">
        canvas {
            margin: auto;
            overflow: hidden;
            border: 1px solid #000;
        }
    </style>
    <script src="input.js"></script>
    <script src="level.js"></script>
    <script src="gameLogic.js"></script>
    <script src="graphics.js"></script>
    <script src="maps.js"></script>
</head>

<body>
    <div style="text-align:center; width:100%; height:100%">
        <div>
            Width:<input id="mapWidth" type="text" value="15"></input>
            Height:<input id="mapHeight" type="text" value="15"></input>
            <input onclick="changeMapSize()" type="button" value="Update Map Size"></input>
            Use 0-8 to select player tile, use Q,W,E, ... P to select units, X to print level (to console)
        </div>
        <canvas id="scene"></canvas>
        <p>Framerate: <span id="fps"></span></p>
    </div>
    <script>
        //currentLevel = new Level(15,15);
        currentLevel = Object.assign(new Level(1,1), maps[0]);



        d = new Date();
        lastframe = d.getTime();
        lastkframe = d.getTime();
        framecount = 0;

        window.onload = function () {
            c = document.getElementById('scene');
            initializeInput(c);
            c.width = window.innerWidth - 100;
            c.height = window.innerHeight - 100;
            cc = c.getContext('2d');
            setInterval(update, 1000 / 60);
        }


        currentPlayerTile = null;
        currentUnit = null;

        function changeMapSize() {
            new_width = document.getElementById("mapWidth").value;
            new_heigth = document.getElementById("mapHeight").value;
            currentLevel.resize(new_width, new_heigth);
        }



        function update() {

            d = new Date();
            tnow = d.getTime();
            tfr = tnow - lastframe;
            lastframe = tnow;

            framecount++;
            if (framecount > 30) {
                fps = Math.floor(1000 / ((tnow - lastkframe) / 30));
                framecount = 0;
                lastkframe = tnow;
                document.getElementById("fps").innerHTML = fps;
            }

            for (i = 48; i < 58; i++) {
                if (keyState[i]) {
                    currentPlayerTile = i - 48;
                    currentUnit = null;
                }
            }
            // codes of Q,W,E,R,...,P
            keys = [81, 87, 69, 82, 84, 89, 85, 73];
            for (i = 0; i < 8; i++) {
                if (keyState[keys[i]]) {
                    currentPlayerTile = null;
                    currentUnit = i;
                }
            }

            if (keyState[65]) {
                globalxoff += 5;
            }
            if (keyState[68]) {
                globalxoff -= 5;
            }
            if (keyState[87]) {
                globalyoff += 5;
            }
            if (keyState[83]) {
                globalyoff -= 5;
            }
            if (keyState[88]) {
                console.log(currentLevel.toJson());
            }

            currentLevel.draw(cc, tnow);
            currentLevel.drawBorder(cc);


            mousePos = pixelsToCoords(mousex, mousey);
            mx = mousePos[0];
            my = mousePos[1];

            if (mx < 0 || my < 0 || mx >= currentLevel.level_width || my >= currentLevel.level_heigth) {
                return;
            }

            cc.globalAlpha = 0.5;
            if (currentPlayerTile != null) {
                if (!keyState['rightMouse']) {
                    drawTile(cc, mx, my, currentPlayerTile);
                }
                if (keyState['leftMouse']) {

                    currentLevel.tileMap[mx][my] = currentPlayerTile;
                }
                if (keyState['rightMouse']) {
                    currentLevel.tileMap[mx][my] = null;
                }
            }

            if (currentUnit != null) {
                drawImage(cc, unitImages[currentUnit], mx, my);
                if (keyState['leftMouse']) {
                    currentLevel.unitMap[mx][my] = currentUnit;
                }
                if (keyState['rightMouse']) {
                    currentLevel.unitMap[mx][my] = null;
                }
            }
            cc.globalAlpha = 1;

        }

    </script>
</body>

</html>